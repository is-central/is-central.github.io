---
const { title = 'Player Dollars', dataUrl = '/events/kazdel-kasino-2/scoreboard.json', refreshMs = 15000 } = Astro.props;
---

<style>
  .scoreboard {
    margin: 1rem 0 2rem 0;
    background: var(--sl-color-bg-nav);
    border: 1px solid var(--sl-color-border);
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 6px 16px rgba(0,0,0,.15);
    width: 100%;
    display: block;
  }
  .scoreboard-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: .875rem 1rem;
    background: var(--sl-color-accent-low);
    border-bottom: 1px solid var(--sl-color-border);
    cursor: pointer;
    transition: background-color 0.2s ease;
  }
  .scoreboard-header:hover {
    background: var(--sl-color-accent);
  }
  .scoreboard-title {
    font-weight: 700;
    margin: 0;
    text-align: center;
    width: 100%;
  }
  .toggle-icon {
    transition: transform 0.3s ease;
    font-weight: bold;
    color: var(--sl-color-text-subtle);
  }
  .scoreboard-body {
    padding: 0 1rem 1rem;
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease, padding 0.3s ease;
  }
  .scoreboard-body.open {
    max-height: 2000px; /* Adjust based on your content */
    padding: 0 1rem 1rem;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    table-layout: fixed;
  }
  thead th {
    text-align: center;
    font-size: .9rem;
    color: var(--sl-color-text-subtle);
    padding: .75rem 0.5rem;
    border-bottom: 2px solid var(--sl-color-border);
    border-right: 1px solid var(--sl-color-hairline);
  }
  thead th:last-child {
    border-right: none;
  }
  tbody td {
    padding: .75rem 0.5rem;
    border-bottom: 1px solid var(--sl-color-hairline);
    word-wrap: break-word;
    overflow-wrap: break-word;
    border-right: 1px solid var(--sl-color-hairline-light);
  }
  tbody td:last-child {
    border-right: none;
  }
  tbody tr:hover {
    background: var(--sl-color-gray-6);
  }
  .team {
    font-weight: 600;
    width: 18%;
    text-align: left;
    color: #3b82f6;
  }
  .player-name {
    width: 12%;
    text-align: left;
    font-size: 0.9rem;
    color: var(--sl-color-purple);
  }
  .player-link {
    text-decoration: none;
    transition: color 0.2s ease;
  }
  .player-link:hover {
    color: var(--sl-color-accent);
    text-decoration: underline;
  }
  .player-dollars {
    width: 8%;
    text-align: center;
    font-variant-numeric: tabular-nums;
    font-weight: 600;
    color: var(--sl-color-green);
  }
  .yen {
    width: 8%;
    text-align: center;
    font-variant-numeric: tabular-nums;
    color: #eab308;
  }
  .updated {
    padding: .5rem 1rem;
    font-size: .8rem;
    color: var(--sl-color-text-subtle);
    text-align: center;
  }
  @media (max-width: 640px) {
    thead { display: none; }
    table, tbody, tr, td { display: block; width: 100%; }
    tbody tr { 
      border-bottom: 1px solid var(--sl-color-border); 
      padding: 0.75rem 0;
      margin-bottom: 0.5rem;
      background: var(--sl-color-bg);
      border-radius: 8px;
      padding: 1rem;
    }
    tbody td { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      padding: 0.5rem 0;
      border-bottom: 1px solid var(--sl-color-hairline-light);
      border-right: none;
    }
    tbody td:last-child {
      border-bottom: none;
    }
    tbody td::before { 
      content: attr(data-label); 
      color: var(--sl-color-text-subtle); 
      font-weight: 600;
      font-size: 0.85rem;
    }
    .player-dollars, .yen { 
      text-align: right;
      font-size: 1rem;
    }
    .player-link {
      text-align: right;
    }
  }
</style>

<div class="scoreboard" id="player-dollars-container">
  <div class="scoreboard-header" id="player-dollars-header">
    <h3 class="scoreboard-title">{title}</h3>
    <span class="toggle-icon" id="player-dollars-toggle">▼</span>
  </div>
  <div class="scoreboard-body" id="player-dollars-body">
    <table id="player-dollars-table">
      <thead>
        <tr>
          <th class="team">Team</th>
          <th class="player-name">Player 1</th>
          <th class="player-dollars">Dollars</th>
          <th class="player-name">Player 2</th>
          <th class="player-dollars">Dollars</th>
          <th class="player-name">Player 3</th>
          <th class="player-dollars">Dollars</th>
          <th class="yen">Yen</th>
        </tr>
      </thead>
      <tbody id="player-dollars-tbody">
        <tr><td class="updated" colspan="8">Loading…</td></tr>
      </tbody>
    </table>
    <div class="updated" id="player-dollars-updated"></div>
  </div>
</div>

<script define:vars={{ dataUrl, refreshMs }}>
  const container = document.getElementById('player-dollars-container');
  if (!container) return;
  
  const header = document.getElementById('player-dollars-header');
  const body = document.getElementById('player-dollars-body');
  const toggle = document.getElementById('player-dollars-toggle');
  const tbody = document.getElementById('player-dollars-tbody');
  const updatedEl = document.getElementById('player-dollars-updated');
  
  if (!header || !body || !toggle || !tbody || !updatedEl) return;

  // Toggle functionality
  header.addEventListener('click', () => {
    body.classList.toggle('open');
    toggle.textContent = body.classList.contains('open') ? '▲' : '▼';
  });

  // Function to create player link HTML
  function createPlayerLink(player) {
    if (!player || !player.name) return '';
    
    if (player.link) {
      return `<a href="${player.link}" class="player-link" target="_blank" rel="noopener noreferrer">${player.name}</a>`;
    } else {
      return player.name;
    }
  }

  async function loadPlayerDollars() {
    try {
      const res = await fetch(dataUrl + '?t=' + Date.now(), { cache: 'no-store' });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      
      const json = await res.json();
      const rows = Array.isArray(json.teams) ? json.teams : [];
      
      tbody.innerHTML = '';
      rows.forEach(team => {
        const tr = document.createElement('tr');
        const playersData = team.playersData || [];
        
        // Get player data - safely handle missing players
        const player1 = playersData[0] || {};
        const player2 = playersData[1] || {};
        const player3 = playersData[2] || {};
        
        // Create player links
        const player1Link = createPlayerLink(player1);
        const player2Link = createPlayerLink(player2);
        const player3Link = createPlayerLink(player3);
        
        tr.innerHTML = `
          <td class="team" data-label="Team">${team.team||''}</td>
          <td class="player-name" data-label="Player 1">${player1Link}</td>
          <td class="player-dollars" data-label="Player 1 Dollars">${player1.dollars || 0}</td>
          <td class="player-name" data-label="Player 2">${player2Link}</td>
          <td class="player-dollars" data-label="Player 2 Dollars">${player2.dollars || 0}</td>
          <td class="player-name" data-label="Player 3">${player3Link}</td>
          <td class="player-dollars" data-label="Player 3 Dollars">${player3.dollars || 0}</td>
          <td class="yen" data-label="Team Yen">${team.yen || 0}</td>
        `;
        tbody.appendChild(tr);
      });
      
      const updated = json.updatedAt ? new Date(json.updatedAt) : new Date();
      updatedEl.textContent = ``;
    } catch (e) {
      tbody.innerHTML = '<tr><td class="updated" colspan="8">Failed to load data: ' + e.message + '</td></tr>';
    }
  }

  loadPlayerDollars();
  setInterval(loadPlayerDollars, refreshMs);
</script>