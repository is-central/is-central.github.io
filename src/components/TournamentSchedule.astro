---
const { title = 'Schedule', dataUrl = '/events/kazdel-kasino-2/schedule.json', refreshMs = 15000 } = Astro.props;
import LocalTime from '../components/LocalTime.astro';
---

<style>
  .schedule {
    margin: 1rem 0 2rem 0;
    background: var(--sl-color-bg-nav);
    border: 1px solid var(--sl-color-border);
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 6px 16px rgba(0,0,0,.15);
    width: 100%;
    display: block;
  }

  .schedule-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: .875rem 1rem;
    background: var(--sl-color-accent-low);
    border-bottom: 1px solid var(--sl-color-border);
    cursor: pointer;
    transition: background-color 0.2s ease;
  }

  .schedule-header:hover {
    background: var(--sl-color-accent);
  }

  .schedule-title {
    margin: 0 auto;
    font-weight: 700;
    text-align: center;
    width: 100%;
  }

  .toggle-icon {
    transition: transform 0.3s ease;
    font-weight: bold;
    color: var(--sl-color-text-subtle);
  }

  .schedule-body {
    padding: 0 1rem 1rem;
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease, padding 0.3s ease;
  }

  .schedule-body.open {
    max-height: 2000px; /* Adjust based on your content */
    padding: 0 1rem 1rem;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    table-layout: fixed;
  }

  thead th {
    text-align: center;
    padding: .75rem 1rem;
    font-size: .9rem;
    color: var(--sl-color-text-subtle);
    border-bottom: 1px solid var(--sl-color-border);
  }

  tbody td {
    padding: .75rem 1rem;
    border-bottom: 1px solid var(--sl-color-hairline);
    word-break: break-word;
    overflow-wrap: break-word;
  }

  .team {
    width: 25%;
    text-align: left;
    color: #3b82f6;
  }
  .player {
    width: 25%;
    text-align: left;
    color: var(--sl-color-purple);
  }
  .time {
    width: 30%;
    text-align: center;
    color: #1dafb9;
  }
  .stream {
    width: 20%;
    text-align: center;
    color: #9147ff;
  }

  tbody tr:hover {
    background: var(--sl-color-gray-6);
  }

  .updated {
    padding: .5rem 1rem;
    font-size: .8rem;
    color: var(--sl-color-text-subtle);
    text-align: center;
  }

  @media (max-width: 640px) {
    thead { 
      display: none; 
    }
    
    table, tbody, tr, td { 
      display: block; 
      width: 100%; 
    }
    
    tbody tr { 
      border-bottom: 1px solid var(--sl-color-border);
      padding: 0.5rem 0;
    }
    
    tbody td { 
      display: flex; 
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem 1rem;
      text-align: right;
      border-bottom: none;
    }
    
    tbody td::before { 
      content: attr(data-label); 
      color: var(--sl-color-text-subtle);
      font-weight: 600;
      text-align: left;
    }

    .time, .stream {
      text-align: right;
    }
  }
</style>

<div class="schedule" id="schedule-container">
  <div class="schedule-header" id="schedule-header">
    <h3 class="schedule-title">{title}</h3>
    <span class="toggle-icon" id="schedule-toggle">▼</span>
  </div>
  <div class="schedule-body" id="schedule-body-container">
    <table>
      <thead>
        <tr>
          <th class="team">Team</th>
          <th class="player">Player</th>
          <th class="time">Local Time</th>
          <th class="stream">Stream</th>
        </tr>
      </thead>
      <tbody id="schedule-tbody">
        <tr><td colspan="4" class="updated">Loading…</td></tr>
      </tbody>
    </table>
    <div class="updated" id="schedule-updated"></div>
  </div>
</div>

<script define:vars={{ dataUrl, refreshMs }}>
  const container = document.getElementById('schedule-container');
  if (!container) return;
  
  const header = document.getElementById('schedule-header');
  const body = document.getElementById('schedule-body-container');
  const toggle = document.getElementById('schedule-toggle');
  const tbody = document.getElementById('schedule-tbody');
  const updatedEl = document.getElementById('schedule-updated');
  
  if (!header || !body || !toggle || !tbody || !updatedEl) return;

  // Toggle functionality
  header.addEventListener('click', () => {
    body.classList.toggle('open');
    toggle.textContent = body.classList.contains('open') ? '▲' : '▼';
  });

  async function loadSchedule() {
    try {
      const res = await fetch(dataUrl + '?t=' + Date.now(), { cache: 'no-store' });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);

      const json = await res.json();
      
      tbody.innerHTML = '';

      json.matches.sort((a, b) => new Date(a.time) - new Date(b.time));
      (json.matches || []).forEach(m => {
        const tr = document.createElement('tr');

        tr.innerHTML = `
          <td class="team" data-label="Team">${m.team || ''}</td>
          <td class="player" data-label="Player">${m.player || ''}</td>
          <td class="time" data-label="Local Time">
            <time data-localdate datetime="${m.time}" data-format="long"></time>
          </td>
          <td class="stream" data-label="Stream">${m.stream || ''}</td>
        `;

        tbody.appendChild(tr);
      });

      // Local time converter
      document.querySelectorAll('[data-localdate]').forEach(el => {
        const date = new Date(el.getAttribute('datetime'));
        el.textContent = date.toLocaleString(undefined, { 
          month: 'short',
          day: 'numeric',
          hour: 'numeric',
          minute: '2-digit'
        });
      });

      updatedEl.textContent = '';
    } catch (e) {
      tbody.innerHTML = `<tr><td colspan="4" class="updated">Failed to load schedule: ${e.message}</td></tr>`;
    }
  }

  loadSchedule();
  setInterval(loadSchedule, refreshMs);
</script>